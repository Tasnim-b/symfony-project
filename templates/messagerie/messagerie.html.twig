<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie - HealFit</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ asset('assets/styles/dashboard.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/styles/messagerie.css') }}">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
<!-- Navbar complète -->
<nav class="dashboard-navbar">
    <div class="navbar-left">
        <a href="{{ path('app_home') }}" class="dashboard-logo">
            <img src="{{ asset('assets/images/healFit-logo.png') }}" alt="HealFit Logo" class="logo-img">
            <span class="logo-text">
                <span class="logo-part1">HEAL</span>
                <span class="logo-part2">FIT</span>
            </span>
        </a>
    </div>

    <div class="navbar-center">
        <h1 class="dashboard-title">Messagerie</h1>
    </div>

    <div class="navbar-right">
        <!-- Notification -->
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">3</span>
        </div>

        <!-- Messagerie active -->
        <div class="messaging-icon active">
            <i class="fas fa-envelope"></i>
            <span class="message-badge" id="globalUnreadCount">
                {% if unreadCount > 0 %}{{ unreadCount }}{% endif %}
            </span>
        </div>

        <!-- Profil Utilisateur -->
        <div class="user-profile-dropdown">
            <div class="user-avatar" id="userMenuTrigger">
                {% if currentUser.profileImage %}
                    <img src="{{ asset('uploads/profile_images/' ~ currentUser.profileImage) }}"
                        alt="Photo de profil"
                        class="profile-img"
                        onerror="this.src='{{ asset('assets/images/default-avatar.jpg') }}'">
                {% else %}
                    <img src="{{ asset('assets/images/default-avatar.jpg') }}"
                        alt="Photo de profil"
                        class="profile-img">
                {% endif %}
                <i class="fas fa-chevron-down"></i>
            </div>

            <div class="dropdown-menu" id="userMenu">
                <div class="user-info">
                    {% if currentUser.profileImage %}
                        <img src="{{ asset('uploads/profile_images/' ~ currentUser.profileImage) }}"
                            alt="Photo de profil"
                            class="menu-profile-img"
                            onerror="this.src='{{ asset('assets/images/default-avatar.jpg') }}'">
                    {% else %}
                        <img src="{{ asset('assets/images/default-avatar.jpg') }}"
                            alt="Photo de profil"
                            class="menu-profile-img">
                    {% endif %}
                    <div class="user-details">
                        <h4>{{ currentUser.fullName }}</h4>
                        <p>Membre {% if 'ROLE_PREMIUM' in currentUser.roles %}Premium{% else %}Standard{% endif %}</p>
                    </div>
                </div>

                <div class="dropdown-divider"></div>

                <a href="{{ path('app_profil') }}" class="dropdown-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Mon Profil</span>
                </a>

                <a href="{{ path('app_dashboard') }}" class="dropdown-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </a>

                <a href="{{ path('app_communaute') }}" class="dropdown-item">
                    <i class="fas fa-users"></i>
                    <span>Communauté</span>
                </a>

                <a href="{{ path('app_messagerie') }}" class="dropdown-item active">
                    <i class="fas fa-envelope"></i>
                    <span>Messagerie</span>
                    {% if unreadCount > 0 %}
                        <span class="menu-badge">{{ unreadCount }}</span>
                    {% endif %}
                </a>

                <a href="#" class="dropdown-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Mes Statistiques</span>
                </a>

                <div class="dropdown-divider"></div>

                <!-- FORMULAIRE DE DÉCONNEXION (POST avec CSRF) -->
                <form action="{{ path('app_logout') }}" method="POST" class="logout-form">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
                    <button type="submit" class="dropdown-item logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Déconnexion</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</nav>

 <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-bars"></i> Menu</h3>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <nav class="sidebar-menu">
                <a href="{{ path('app_dashboard') }}" class="menu-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </a>

                <div class="menu-section">
                    <h4>Santé & Fitness</h4>

                    <a href="#" class="menu-item">
                        <i class="fas fa-utensils"></i>
                        <span>Régime alimentaire</span>
                        <span class="badge">Nouveau</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-dumbbell"></i>
                        <span>Workout personnalisé</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Planning d'entraînement</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Salle de sport proche</span>
                    </a>
                </div>

                <div class="menu-section">
                    <h4>Expertise</h4>

                    <a href="#" class="menu-item">
                        <i class="fas fa-user-md"></i>
                        <span>Nutritionniste expert</span>
                    </a>

                    <a href="{{ path('app_communaute') }}" class="menu-item">
                        <i class="fas fa-users"></i>
                        <span>Communauté</span>
                        <span class="badge">{{ getTotalUsers() }}</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>Partenaires fitness</span>
                    </a>
                </div>

                <div class="menu-section">
                    <h4>Progression</h4>

                    <a href="#" class="menu-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Mes progrès</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-trophy"></i>
                        <span>Mes objectifs</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-award"></i>
                        <span>Mes badges</span>
                        <span class="badge">8</span>
                    </a>
                </div>

                <div class="menu-section">
                    <h4>Ressources</h4>

                    <a href="#" class="menu-item">
                        <i class="fas fa-book"></i>
                        <span>Guide santé</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-video"></i>
                        <span>Vidéos d'exercices</span>
                    </a>

                    <a href="#" class="menu-item">
                        <i class="fas fa-file-alt"></i>
                        <span>Rapports mensuels</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-progress">
                    <div class="progress-info">
                        <span>Progression mensuelle</span>
                        <span>65%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                </div>

                <button class="premium-btn">
                    <i class="fas fa-crown"></i>
                    Passer à Premium
                </button>
            </div>
        </aside>

        <!-- Contenu principal - Messagerie -->
        <main class="dashboard-content">
            <div class="messagerie-container">
                <!-- En-tête -->
                <div class="messagerie-header">
                    <h2><i class="fas fa-comments"></i> Messagerie</h2>
                    <p>Communiquez avec les membres de la communauté</p>
                </div>

                <div class="messagerie-content">
                    <!-- Liste des conversations -->
                    <div class="conversations-sidebar">
                        <div class="sidebar-header">
                            <h3>Conversations</h3>
                            <button class="new-conversation-btn" id="newConversationBtn">
                                <i class="fas fa-edit"></i> Nouveau message
                            </button>
                        </div>

                        <!-- Recherche -->
                        <div class="conversation-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchConversations" placeholder="Rechercher une conversation...">
                        </div>

                        <!-- Liste des conversations -->
                        <div class="conversations-list" id="conversationsList">
                            {% if conversations|length > 0 %}
                                {% for user in conversations %}
                                    <div class="conversation-item" data-user-id="{{ user.id }}">
                                        <div class="conversation-avatar">
                                            {% if user.profileImage %}
                                                <img src="{{ asset('uploads/profile_images/' ~ user.profileImage) }}"
                                                    alt="{{ user.fullName }}"
                                                    onerror="this.src='{{ asset('assets/images/default-avatar.jpg') }}'">
                                            {% else %}
                                                <img src="{{ asset('assets/images/default-avatar.jpg') }}"
                                                    alt="{{ user.fullName }}">
                                            {% endif %}
                                        </div>
                                        <div class="conversation-info">
                                            <h4>{{ user.fullName }}</h4>
                                                <p class="last-message">
                                                    {% set lastSent = user.sentMessages|last %}
                                                    {% set lastReceived = user.receivedMessages|last %}

                                                    {% if lastSent %}
                                                        {{ lastSent.content|slice(0, 50) }}{{ lastSent.content|length > 50 ? '...' : '' }}
                                                    {% elseif lastReceived %}
                                                        {{ lastReceived.content|slice(0, 50) }}{{ lastReceived.content|length > 50 ? '...' : '' }}
                                                    {% else %}
                                                        Commencez une conversation
                                                    {% endif %}
                                                </p>
                                        </div>
                                        <div class="conversation-meta">
                                                <span class="message-time">
                                                    {% set lastSent = user.sentMessages|last %}
                                                    {% set lastReceived = user.receivedMessages|last %}

                                                    {% if lastSent %}
                                                        {{ lastSent.createdAt|date('H:i') }}
                                                    {% elseif lastReceived %}
                                                        {{ lastReceived.createdAt|date('H:i') }}
                                                    {% else %}
                                                        --
                                                    {% endif %}
                                                </span>
                                            {% set unreadCount = 0 %}
                                            {% for message in user.sentMessages %}
                                                {% if not message.isRead and message.receiver.id == currentUser.id %}
                                                    {% set unreadCount = unreadCount + 1 %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if unreadCount > 0 %}
                                                <span class="unread-badge">{{ unreadCount }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-conversations">
                                    <i class="fas fa-comment-slash"></i>
                                    <p>Aucune conversation</p>
                                </div>
                            {% endif %}
                        </div>


                    </div>

                    <!-- Zone de conversation -->
                    <div class="conversation-main">
                        <!-- Aucune conversation sélectionnée -->
                        <div class="no-conversation-selected" id="noConversationSelected">
                            <i class="fas fa-comments"></i>
                            <h3>Sélectionnez une conversation</h3>
                            <p>Choisissez une conversation dans la liste pour commencer à discuter</p>
                        </div>

                        <!-- Conversation active (cachée par défaut) -->
                        <div class="conversation-active" id="conversationActive" style="display: none;">
                            <!-- En-tête de la conversation -->
                            <div class="conversation-header">
                                <div class="conversation-user-info">
                                    <div class="user-avatar-small">
                                        <img id="activeConversationAvatar" src="" alt="">
                                    </div>
                                    <div class="user-details">
                                        <h3 id="activeConversationName"></h3>
                                        <p class="user-status" id="activeConversationStatus">
                                            <i class="fas fa-circle"></i> <span>En ligne</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="conversation-actions">
                                    <button class="action-btn" title="Appeler">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <button class="action-btn" title="Informations">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div class="messages-container" id="messagesContainer">
                                <!-- Messages seront chargés ici via JavaScript -->
                            </div>

                            <!-- Formulaire d'envoi -->
                            <div class="message-input-container">
                                <form id="sendMessageForm">
                                    <div class="input-group">
                                        <button type="button" class="input-action-btn">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <textarea id="messageInput"
                                                  placeholder="Tapez votre message..."
                                                  rows="1"></textarea>
                                        <button type="submit" class="send-btn">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des contacts pour nouveau message -->
                    <div class="contacts-sidebar" id="contactsSidebar" style="display: none;">
                        <div class="sidebar-header">
                            <h3>Nouveau message</h3>
                            <button class="close-contacts-btn" id="closeContactsBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="contacts-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchContacts" placeholder="Rechercher un membre...">
                        </div>

                        <div class="contacts-list" id="contactsList">
                            {% for user in users %}
                                <div class="contact-item" data-user-id="{{ user.id }}">
                                    <div class="contact-avatar">
                                        {% if user.profileImage %}
                                            <img src="{{ asset('uploads/profile_images/' ~ user.profileImage) }}"
                                                 alt="{{ user.fullName }}"
                                                 onerror="this.src='{{ asset('assets/images/default-avatar.jpg') }}'">
                                        {% else %}
                                            <img src="{{ asset('assets/images/default-avatar.jpg') }}"
                                                 alt="{{ user.fullName }}">
                                        {% endif %}
                                    </div>
                                    <div class="contact-info">
                                        <h4>{{ user.fullName }}</h4>
                                        <p class="contact-email">{{ user.email }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Templates pour les messages -->
    <template id="messageTemplate">
        <div class="message" data-message-id="">
            <div class="message-content">
                <p class="message-text"></p>
                <div class="message-meta">
                    <span class="message-time"></span>
                    <i class="fas fa-check-double read-status"></i>
                </div>
            </div>
        </div>
    </template>

    <template id="dateSeparatorTemplate">
        <div class="date-separator">
            <span></span>
        </div>
    </template>

    <!-- JavaScript -->
    <script>
        // Variables globales
        window.currentUser = {
            id: {{ currentUser.id }},
            name: "{{ currentUser.fullName|e('js') }}",
            avatar: "{{ currentUser.profileImage ? asset('uploads/profile_images/' ~ currentUser.profileImage) : asset('assets/images/default-avatar.jpg') }}"
        };

        window.activeConversation = null;
        window.messageCheckInterval = null;
    </script>

    <script src="{{ asset('js/messagerie.js') }}"></script>
</body>
</html>
